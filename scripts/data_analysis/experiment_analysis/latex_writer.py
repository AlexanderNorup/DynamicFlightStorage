from io import StringIO
from string import Template

def round_if_not_str(input):
    if not isinstance(input, float):
        return input
    return f"{input:_.2f}".replace("_", "~")

class LatexWriter:
    def __init__(self):
        self.output = StringIO()
        self.output.write("% @AUTOGENERATED\n% THIS FILE IS AUTOGENERATED\n%%%%%%%%%%%%%%%\n")
        with open("experiment_template.tex", "r") as f:
            self.template = Template(f.read())
        self.table_line_template = Template("$data_store & $recalc & $weather_lag & $flight_lag & $weather_rate & $flight_rate \\\\ \\hline")

    def add_experiment(self, experiment_name: str, data_stores):
        simple_name = experiment_name.lower().replace(" ", "_")
        table_tex = StringIO()
        for data_store in data_stores:
            table_tex.write(self.table_line_template.substitute(
                data_store=data_store[0],
                recalc=round_if_not_str(data_store[1]),
                weather_lag=round_if_not_str(data_store[2]),
                flight_lag=round_if_not_str(data_store[3]),
                weather_rate=round_if_not_str(data_store[4]),
                flight_rate=round_if_not_str(data_store[5]),
            ))
            table_tex.write("\n")

        self.output.write(self.template.substitute(
            experiment_name=experiment_name,
            experiment_simple_name=simple_name,
            table_tex=table_tex.getvalue()
        ))
        self.output.write("\n\n")
    
    def write_file(self, path: str):
        with open(path, "w") as f:
            f.write(self.output.getvalue())